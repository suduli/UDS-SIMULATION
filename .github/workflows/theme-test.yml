name: Theme Testing

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  theme-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm ci
          npm install --save-dev playwright pngjs pixelmatch
          npx playwright install chromium
          
      - name: Build application
        run: npm run build
        
      - name: Start preview server
        run: |
          npm run preview &
          echo $! > preview.pid
        
      - name: Wait for server
        run: npx wait-on http://localhost:4173/UDS-SIMULATION/ --timeout 30000
        
      - name: Run theme tests
        run: node theme-test-playwright.cjs http://localhost:4173/UDS-SIMULATION/
        
      - name: Create visual diffs
        run: node theme-test-visual-diff.cjs
        continue-on-error: true
        
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: theme-test-results
          path: results/
          retention-days: 30
          
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: theme-screenshots
          path: |
            results/*.png
            results/diffs/*.png
          retention-days: 30
          
      - name: Check test results
        id: check-results
        continue-on-error: true
        run: |
          if [ -f results/report.json ]; then
            FAILURES=$(node -p "JSON.parse(require('fs').readFileSync('results/report.json', 'utf8')).summary.failures.length")
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            if [ "$FAILURES" -gt 0 ]; then
              echo "âš ï¸ Theme tests failed with $FAILURES contrast failures (non-blocking)"
              exit 1
            else
              echo "âœ… All theme tests passed!"
            fi
          else
            echo "âš ï¸ Report file not found (non-blocking)"
            exit 1
          fi
          
      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs')
            
            if (!fs.existsSync('results/report.json')) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## âŒ Theme Test Failed\n\nCould not generate test report. Check workflow logs.'
              })
              return
            }
            
            const report = JSON.parse(fs.readFileSync('results/report.json', 'utf8'))
            const summary = report.summary
            
            let comment = `## ðŸŽ¨ Theme Test Results\n\n`
            comment += `- **Total Checks**: ${summary.totalChecks}\n`
            comment += `- **Failures**: ${summary.failures.length} âŒ\n`
            comment += `- **Warnings**: ${summary.warnings.length} âš ï¸\n`
            comment += `- **Overall**: ${summary.pass ? 'âœ… PASS' : 'âŒ FAIL'}\n\n`
            
            if (summary.failures.length > 0) {
              comment += `### âŒ Contrast Failures (WCAG AA)\n\n`
              comment += `| Theme | Element | Ratio | Required | Colors |\n`
              comment += `|-------|---------|-------|----------|--------|\n`
              summary.failures.forEach(f => {
                comment += `| ${f.theme} | ${f.selector} | ${f.ratio}:1 | 4.5:1 | \`${f.fg}\` on \`${f.bg}\` |\n`
              })
              comment += `\n`
            }
            
            if (summary.warnings.length > 0) {
              comment += `### âš ï¸ Warnings (AA but not AAA)\n\n`
              summary.warnings.forEach(w => {
                comment += `- **${w.theme}** - ${w.selector}: ${w.ratio}:1 (${w.note})\n`
              })
              comment += `\n`
            }
            
            if (summary.suggestions.length > 0) {
              comment += `### ðŸ’¡ Suggestions\n\n`
              summary.suggestions.forEach(s => {
                comment += `- ${s}\n`
              })
              comment += `\n`
            }
            
            comment += `\n---\n`
            comment += `ðŸ“¸ [View screenshots and full report in artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })
            
      - name: Cleanup
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
          fi
