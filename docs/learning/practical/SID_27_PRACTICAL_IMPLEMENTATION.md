# SID 0x27: Security Access - Practical Implementation Guide

**Version:** 2.0  
**Last Updated:** October 12, 2025  
**Compliance:** ISO 14229-1:2020 Section 9.3  
**Format:** Visual diagrams only - NO programming code

---

## ğŸ“‹ Table of Contents

1. [Seed Generation Flowchart](#seed-generation-flowchart)
2. [Key Validation Logic](#key-validation-logic)
3. [Security State Machine](#security-state-machine)
4. [Timeout Handling](#timeout-handling)
5. [Attempt Counter Logic](#attempt-counter-logic)
6. [Testing Scenarios](#testing-scenarios)
7. [Debugging Flowcharts](#debugging-flowcharts)

---

## Seed Generation Flowchart

### Complete Request Processing

```
                         START: Receive Request
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Parse Request Message    â”‚
                    â”‚ Extract: SID, Sub-Func   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Validate SID = 0x27?     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                 â”‚
                       YES               NO
                        â”‚                 â”‚
                        â–¼                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Check Sub-Func    â”‚   â”‚ Wrong SID    â”‚
            â”‚ Odd or Even?      â”‚   â”‚ Route to     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ other serviceâ”‚
                      â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚
           ODD                EVEN
    (Request Seed)      (Send Key)
            â”‚                   â”‚
            â–¼                   â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ SEED REQUEST     â”‚  â”‚ KEY VALIDATION   â”‚
  â”‚ Processing       â”‚  â”‚ Processing       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚
            â–¼                     â–¼
    (See detailed              (See key
     flowchart below)           validation below)
```

### Seed Request Detailed Flow

```
                    START: Odd Sub-Function Received
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check Current Session    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
              Extended/Prog              Default
                    â”‚                         â”‚
                    â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Session OK      â”‚      â”‚ Return NRC 0x7F  â”‚
         â”‚ Continue...     â”‚      â”‚ (Service Not     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  Supported in    â”‚
                  â”‚               â”‚  Active Session) â”‚
                  â–¼               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Sub-Func         â”‚
         â”‚ Supported?       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
        YES               NO
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check if       â”‚  â”‚ Return NRC 0x12  â”‚
â”‚ already        â”‚  â”‚ (Sub-Function    â”‚
â”‚ unlocked       â”‚  â”‚  Not Supported)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚
â”‚           Already
Locked         Unlocked
â”‚                â”‚
â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate   â”‚  â”‚ Return seed =    â”‚
â”‚ Random     â”‚  â”‚ all zeros        â”‚
â”‚ Seed       â”‚  â”‚ [0x67][SF][00...â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store Seed     â”‚
â”‚ internally     â”‚
â”‚ (for later     â”‚
â”‚  validation)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Start Seed     â”‚
â”‚ Timeout Timer  â”‚
â”‚ (e.g., 5s)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set State =    â”‚
â”‚ SEED_REQUESTED â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Positive        â”‚
â”‚ Response:              â”‚
â”‚ [0x67][SF][SEED...]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
      END
```

### Random Seed Generation Requirements

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SEED GENERATION REQUIREMENTS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Randomness Properties:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Cryptographically strong random number generator       â”‚  â”‚
â”‚  â”‚ â€¢ No predictable patterns                                â”‚  â”‚
â”‚  â”‚ â€¢ Each seed unique per request                           â”‚  â”‚
â”‚  â”‚ â€¢ Sufficient entropy (typically â‰¥ 32 bits)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Seed Sources:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Hardware RNG        â”‚ â† Best security                        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”‚
â”‚  â”‚ Timer + Counter     â”‚ â† Medium security                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”‚
â”‚  â”‚ Pseudo-RNG + Seed   â”‚ â† Acceptable if seeded properly        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                 â”‚
â”‚  Anti-Pattern: DO NOT USE                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âŒ Sequential numbers (0x0001, 0x0002, 0x0003...)        â”‚  â”‚
â”‚  â”‚ âŒ Timestamp only (predictable)                          â”‚  â”‚
â”‚  â”‚ âŒ Fixed seed (same seed every time)                     â”‚  â”‚
â”‚  â”‚ âŒ Simple XOR patterns                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Validation Logic

### Complete Validation Decision Tree

```
                    START: Receive Key (Even Sub-Func)
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check Current State      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
              SEED_REQUESTED              Other State
                    â”‚                         â”‚
                    â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ State OK        â”‚      â”‚ Return NRC 0x22  â”‚
         â”‚ Continue...     â”‚      â”‚ (Conditions Not  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  Correct - No    â”‚
                  â”‚               â”‚  Seed Requested) â”‚
                  â–¼               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Sub-Func Matches â”‚
         â”‚ Seed Request?    â”‚
         â”‚ (Even = Odd+1)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
        YES               NO
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Message  â”‚  â”‚ Return NRC 0x24  â”‚
â”‚ Length         â”‚  â”‚ (Request         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Sequence Error) â”‚
        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚
Correct      Incorrect
Length         Length
â”‚                â”‚
â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check      â”‚  â”‚ Return NRC 0x13  â”‚
â”‚ Attempt    â”‚  â”‚ (Incorrect       â”‚
â”‚ Counter    â”‚  â”‚  Message Length) â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚            â”‚
Below      At/Above
Limit       Limit
â”‚            â”‚
â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check    â”‚  â”‚ Return NRC 0x36  â”‚
â”‚ Delay    â”‚  â”‚ (Exceeded        â”‚
â”‚ Timer    â”‚  â”‚  Attempts)       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚          â”‚
Expired  Active
â”‚          â”‚
â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate  â”‚  â”‚ Return NRC 0x37  â”‚
â”‚ Expected   â”‚  â”‚ (Time Delay Not  â”‚
â”‚ Key        â”‚  â”‚  Expired)        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compare Keys:   â”‚
â”‚ Received vs     â”‚
â”‚ Expected        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚          â”‚
  Match    Mismatch
    â”‚          â”‚
    â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS!   â”‚  â”‚ FAILURE!         â”‚
â”‚            â”‚  â”‚                  â”‚
â”‚ â€¢ Reset    â”‚  â”‚ â€¢ Increment      â”‚
â”‚   counter  â”‚  â”‚   attempt counterâ”‚
â”‚ â€¢ Set      â”‚  â”‚ â€¢ Start delay    â”‚
â”‚   state =  â”‚  â”‚   timer          â”‚
â”‚   UNLOCKED â”‚  â”‚ â€¢ Keep state =   â”‚
â”‚ â€¢ Return   â”‚  â”‚   LOCKED         â”‚
â”‚   0x67 SF  â”‚  â”‚ â€¢ Return         â”‚
â”‚            â”‚  â”‚   NRC 0x35       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Calculation Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              KEY CALCULATION PROCESS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Input:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Seed Received:    0x12 0x34 0x56 0x78                    â”‚  â”‚
â”‚  â”‚ Secret Key:       0xAB 0xCD 0xEF 0x01 (stored in ECU)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Algorithm Options:                                             â”‚
â”‚                                                                 â”‚
â”‚  Option 1: Simple XOR (NOT RECOMMENDED - Too Weak)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Seed:     12 34 56 78                                  â”‚  â”‚
â”‚  â”‚   XOR Key:  AB CD EF 01                                  â”‚  â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚  â”‚
â”‚  â”‚   Result:   B9 F9 B9 79                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Option 2: AES Encryption (RECOMMENDED)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Key = AES_Encrypt(Seed, Secret_AES_Key)                â”‚  â”‚
â”‚  â”‚   Result: [Cryptographically Strong Output]              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Option 3: Custom Proprietary Algorithm                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Key = OEM_Crypto_Func(Seed, Secret)                    â”‚  â”‚
â”‚  â”‚   Note: Algorithm shared between Tester & ECU            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Both Tester and ECU MUST use identical algorithm!              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security State Machine

### Complete State Diagram

```
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   POWER ON /    â”‚
                          â”‚  SESSION CHANGE â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘       LOCKED STATE       â•‘
                    â•‘  â€¢ No protected access   â•‘
                    â•‘  â€¢ Counter = 0           â•‘
                    â•‘  â€¢ No active seed        â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                â”‚
                                â”‚ Request Seed (0x27 Odd)
                                â”‚ â†“ Response: Seed
                                â–¼
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘   SEED_REQUESTED STATE   â•‘
                    â•‘  â€¢ Seed generated        â•‘
                    â•‘  â€¢ Seed timeout active   â•‘
                    â•‘  â€¢ Waiting for key       â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           â”‚           â”‚
              Valid Key    Invalid Key  Timeout
              (0x27 Even)  (0x27 Even)  (5 seconds)
                    â”‚           â”‚           â”‚
                    â–¼           â–¼           â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â•‘   UNLOCKED    â•‘  â”‚  Counter++ â”‚  â”‚ Return to  â”‚
        â•‘    STATE      â•‘  â”‚  Delay     â”‚  â”‚  LOCKED    â”‚
        â•‘ â€¢ Protected   â•‘  â”‚  Timer     â”‚  â”‚  STATE     â”‚
        â•‘   access OK   â•‘  â”‚  Start     â”‚  â”‚            â”‚
        â•‘ â€¢ S3 timer    â•‘  â”‚            â”‚  â”‚            â”‚
        â•‘   active      â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â•šâ•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•         â”‚
                â”‚                 â”‚
                â”‚                 â””â”€â”€â–º Back to LOCKED
                â”‚                      (NRC 0x35)
                â”‚
                â”‚ Protected Operation
                â”‚ (e.g., Write DID)
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Operation    â”‚
        â”‚  Executes     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚           â”‚
S3 Timeout  Session    TesterPresent
 (5 sec)     Change     (Keep Alive)
    â”‚           â”‚           â”‚
    â–¼           â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ Return  â”‚ â”‚ Return  â”‚    â”‚
â”‚ to      â”‚ â”‚ to      â”‚    â”‚
â”‚ LOCKED  â”‚ â”‚ LOCKED  â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                            â”‚
                            â””â”€â”€â–º Stay UNLOCKED
                                 (Reset S3 timer)
```

### State Transition Table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Current      â”‚ Event           â”‚ Next State  â”‚ Action           â”‚
â”‚ State        â”‚                 â”‚             â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LOCKED       â”‚ Request Seed    â”‚ SEED_REQ    â”‚ Generate seed,   â”‚
â”‚              â”‚ (0x27 Odd)      â”‚             â”‚ start timeout    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LOCKED       â”‚ Send Key        â”‚ LOCKED      â”‚ NRC 0x22         â”‚
â”‚              â”‚ (0x27 Even)     â”‚             â”‚ (No seed req'd)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SEED_REQ     â”‚ Valid Key       â”‚ UNLOCKED    â”‚ Reset counter,   â”‚
â”‚              â”‚                 â”‚             â”‚ start S3 timer   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SEED_REQ     â”‚ Invalid Key     â”‚ LOCKED      â”‚ Counter++,       â”‚
â”‚              â”‚                 â”‚             â”‚ NRC 0x35, delay  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SEED_REQ     â”‚ Seed Timeout    â”‚ LOCKED      â”‚ Clear seed       â”‚
â”‚              â”‚ (5 sec)         â”‚             â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNLOCKED     â”‚ S3 Timeout      â”‚ LOCKED      â”‚ Lost security    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNLOCKED     â”‚ Session Change  â”‚ LOCKED      â”‚ Lost security    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNLOCKED     â”‚ TesterPresent   â”‚ UNLOCKED    â”‚ Reset S3 timer   â”‚
â”‚              â”‚ (0x3E)          â”‚             â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UNLOCKED     â”‚ Request Seed    â”‚ UNLOCKED    â”‚ Return zeros     â”‚
â”‚              â”‚ (same level)    â”‚             â”‚ (already open)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Any          â”‚ Power Cycle     â”‚ LOCKED      â”‚ Reset all        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Timeout Handling

### Seed Timeout Logic

```
                    SEED GENERATED & SENT
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Start Timeout Timer â”‚
                  â”‚ Duration: 5 seconds â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   TIMER RUNNING (0-5s)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
    Key Received    Timeout Expires  New Seed Request
    before 5s         at 5s            (overwrites old)
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stop Timer     â”‚  â”‚ Stop Timer  â”‚  â”‚ Cancel Old     â”‚
â”‚ Validate Key   â”‚  â”‚ Clear Seed  â”‚  â”‚ Generate New   â”‚
â”‚                â”‚  â”‚ State =     â”‚  â”‚ Start New      â”‚
â”‚ If Valid:      â”‚  â”‚ LOCKED      â”‚  â”‚ Timer          â”‚
â”‚   UNLOCKED     â”‚  â”‚             â”‚  â”‚                â”‚
â”‚                â”‚  â”‚ Next key    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ If Invalid:    â”‚  â”‚ attempt     â”‚
â”‚   LOCKED       â”‚  â”‚ needs new   â”‚
â”‚   NRC 0x35     â”‚  â”‚ seed req    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### S3 Timeout (Session Alive)

```
               SECURITY UNLOCKED
                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Start S3 Timer        â”‚
          â”‚ Duration: 5 seconds   â”‚
          â”‚ (Typical Value)       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ S3 TIMER COUNTDOWN (0-5s)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚           â”‚
    TesterPresent  Timeout    Protected
      (0x3E)       (5s)       Operation
          â”‚           â”‚           â”‚
          â–¼           â–¼           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Reset S3  â”‚  â”‚ Session â”‚  â”‚ Operation â”‚
  â”‚ Timer to  â”‚  â”‚ Timeout â”‚  â”‚ Executes  â”‚
  â”‚ 5 seconds â”‚  â”‚         â”‚  â”‚           â”‚
  â”‚           â”‚  â”‚ State = â”‚  â”‚ S3 keeps  â”‚
  â”‚ Stay      â”‚  â”‚ Default â”‚  â”‚ running   â”‚
  â”‚ UNLOCKED  â”‚  â”‚         â”‚  â”‚           â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚ State = â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚        â”‚ LOCKED  â”‚        â”‚
        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
        â”‚                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              Keep Monitoring
```

### Delay Timer (After Invalid Key)

```
           INVALID KEY SENT (NRC 0x35)
                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Start Delay Timer     â”‚
          â”‚ Duration: 10 seconds  â”‚
          â”‚ Increment Counter     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ DELAY ACTIVE (0-10s)        â”‚
        â”‚ Cannot request seed         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚           â”‚
    Delay Active  Delay      Power Cycle
    (0-9 sec)     Expired    (Reset all)
          â”‚        (10s)         â”‚
          â–¼           â–¼           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Seed      â”‚  â”‚ Can     â”‚  â”‚ Counter = â”‚
  â”‚ Request?  â”‚  â”‚ request â”‚  â”‚ 0         â”‚
  â”‚           â”‚  â”‚ seed    â”‚  â”‚ Delay =   â”‚
  â”‚ â†’ NRC 0x37â”‚  â”‚ again   â”‚  â”‚ 0         â”‚
  â”‚ (Time     â”‚  â”‚         â”‚  â”‚ State =   â”‚
  â”‚  delay    â”‚  â”‚ Counter â”‚  â”‚ LOCKED    â”‚
  â”‚  not      â”‚  â”‚ still   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  expired) â”‚  â”‚ counts  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ failuresâ”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Attempt Counter Logic

### Counter State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   POWER ON /    â”‚
                    â”‚  VALID UNLOCK   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                  â•‘   COUNTER = 0        â•‘
                  â•‘   Ready for attempts â•‘
                  â•šâ•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â”‚
                            â”‚ Invalid Key
                            â–¼
                  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                  â•‘   COUNTER = 1        â•‘
                  â•‘   Warning: 2 left    â•‘
                  â•šâ•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â”‚
                            â”‚ Invalid Key
                            â–¼
                  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                  â•‘   COUNTER = 2        â•‘
                  â•‘   Warning: 1 left    â•‘
                  â•šâ•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â”‚
                            â”‚ Invalid Key
                            â–¼
                  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                  â•‘   COUNTER = 3        â•‘
                  â•‘   LOCKOUT!           â•‘
                  â•‘   NRC 0x36           â•‘
                  â•šâ•â•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
          Power Cycle              Wait Period
          (Immediate)              (10 minutes)
                â”‚                       â”‚
                â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Counter = 0   â”‚      â”‚ Counter = 0   â”‚
        â”‚ Delay = 0     â”‚      â”‚ Delay = 0     â”‚
        â”‚ State = LOCKEDâ”‚      â”‚ State = LOCKEDâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Counter Management Flowchart

```
                    Receive Send Key Request
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Check Attempt       â”‚
                  â”‚ Counter             â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                       â”‚
           Counter < Max           Counter >= Max
           (e.g., < 3)             (e.g., >= 3)
                 â”‚                       â”‚
                 â–¼                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Validate Key        â”‚   â”‚ Return NRC 0x36  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ (Exceeded        â”‚
                 â”‚               â”‚  Attempts)       â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                  â”‚
     â”‚                    â”‚     â”‚ Ignore key       â”‚
  Valid Key          Invalid    â”‚ validation       â”‚
     â”‚                    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS!    â”‚   â”‚ FAILURE!         â”‚
â”‚             â”‚   â”‚                  â”‚
â”‚ â€¢ Counter   â”‚   â”‚ â€¢ Counter++      â”‚
â”‚   = 0       â”‚   â”‚ â€¢ Start delay    â”‚
â”‚ â€¢ Delay = 0 â”‚   â”‚   timer (10s)    â”‚
â”‚ â€¢ State =   â”‚   â”‚ â€¢ Return         â”‚
â”‚   UNLOCKED  â”‚   â”‚   NRC 0x35       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Check if Counter    â”‚
                  â”‚ reached Max         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                       â”‚
          Still Below Max          At Max Now
           (e.g., 1 or 2)           (e.g., 3)
                 â”‚                       â”‚
                 â–¼                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Can try again       â”‚   â”‚ LOCKOUT ACTIVE   â”‚
      â”‚ after delay         â”‚   â”‚ Need power cycle â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ or long wait     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing Scenarios

### Scenario 1: Successful Unlock (Happy Path)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 1: Successful Security Unlock                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Diagnostic Session (0x10 0x03)                â”‚
â”‚ â€¢ Security state = LOCKED                                       â”‚
â”‚ â€¢ Attempt counter = 0                                           â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Request Seed                                            â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x67] [0x01] [SEED_4_BYTES]                    â”‚
â”‚   Verify:       âœ“ Positive response                             â”‚
â”‚                 âœ“ Seed is non-zero                              â”‚
â”‚                 âœ“ Seed length = 4 bytes                         â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Calculate Key                                           â”‚
â”‚   Key = CryptoAlgorithm(Seed, Secret)                           â”‚
â”‚   Example: If seed = 0x12345678                                 â”‚
â”‚            Then key = 0xABCDEF01 (from algorithm)               â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Send Key                                                â”‚
â”‚   Tester â†’ ECU: [0x27] [0x02] [0xAB] [0xCD] [0xEF] [0x01]      â”‚
â”‚   Expected:     [0x67] [0x02]                                   â”‚
â”‚   Verify:       âœ“ Positive response                             â”‚
â”‚                 âœ“ Response length = 2 bytes                     â”‚
â”‚                                                                 â”‚
â”‚ Step 4: Verify Unlock                                           â”‚
â”‚   Tester â†’ ECU: [0x2E] [0xF1] [0x90] [0x12] [0x34]             â”‚
â”‚                 (Write to protected DID)                        â”‚
â”‚   Expected:     [0x6E] [0xF1] [0x90]                            â”‚
â”‚   Verify:       âœ“ Protected operation succeeds                  â”‚
â”‚                 âœ“ No NRC 0x33 (security not met)                â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Security state = UNLOCKED                                     â”‚
â”‚ â€¢ Attempt counter = 0 (reset)                                   â”‚
â”‚ â€¢ Can perform protected operations                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 2: Invalid Key

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 2: Invalid Key Response                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Session                                       â”‚
â”‚ â€¢ Security state = LOCKED                                       â”‚
â”‚ â€¢ Attempt counter = 0                                           â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Request Seed                                            â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x67] [0x01] [SEED]                            â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Send WRONG Key                                          â”‚
â”‚   Tester â†’ ECU: [0x27] [0x02] [0x00] [0x00] [0x00] [0x00]      â”‚
â”‚                 (Intentionally wrong)                           â”‚
â”‚   Expected:     [0x7F] [0x27] [0x35]                            â”‚
â”‚   Verify:       âœ“ NRC 0x35 (Invalid Key)                        â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Attempt Counter Check                                   â”‚
â”‚   Internal State: Counter = 1                                   â”‚
â”‚                                                                 â”‚
â”‚ Step 4: Try Protected Operation                                 â”‚
â”‚   Tester â†’ ECU: [0x2E] [0xF1] [0x90] [DATA]                     â”‚
â”‚   Expected:     [0x7F] [0x2E] [0x33]                            â”‚
â”‚   Verify:       âœ“ NRC 0x33 (Security Access Denied)             â”‚
â”‚                 âœ“ Still locked                                  â”‚
â”‚                                                                 â”‚
â”‚ Step 5: Immediate Retry (Delay Active)                          â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x7F] [0x27] [0x37]                            â”‚
â”‚   Verify:       âœ“ NRC 0x37 (Time Delay Not Expired)             â”‚
â”‚                                                                 â”‚
â”‚ Step 6: Wait for Delay (10 seconds)                             â”‚
â”‚   Wait Time: 10 seconds                                         â”‚
â”‚                                                                 â”‚
â”‚ Step 7: Request Seed Again                                      â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x67] [0x01] [NEW_SEED]                        â”‚
â”‚   Verify:       âœ“ New seed provided (different from Step 1)     â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Security state = SEED_REQUESTED                               â”‚
â”‚ â€¢ Attempt counter = 1                                           â”‚
â”‚ â€¢ Delay timer expired                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 3: Timeout During Seed Request

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 3: Seed Timeout                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Session                                       â”‚
â”‚ â€¢ Seed timeout configured = 5 seconds                           â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Request Seed                                            â”‚
â”‚   Time 0:00 - Tester â†’ ECU: [0x27] [0x01]                       â”‚
â”‚   Expected:            ECU â†’ Tester: [0x67] [0x01] [SEED]       â”‚
â”‚   Verify:   âœ“ Seed received                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Wait Beyond Timeout                                     â”‚
â”‚   Time 0:06 - (6 seconds elapsed, > 5 second timeout)           â”‚
â”‚   Action: Send key (too late)                                   â”‚
â”‚                                                                 â”‚
â”‚   Tester â†’ ECU: [0x27] [0x02] [CORRECT_KEY]                     â”‚
â”‚   Expected:     [0x7F] [0x27] [0x22]                            â”‚
â”‚   Verify:       âœ“ NRC 0x22 (Conditions Not Correct)             â”‚
â”‚                 âœ“ Seed expired, state = LOCKED                  â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Request New Seed                                        â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x67] [0x01] [NEW_SEED]                        â”‚
â”‚   Verify:       âœ“ New seed generated                            â”‚
â”‚                 âœ“ Different from Step 1 seed                    â”‚
â”‚                                                                 â”‚
â”‚ Step 4: Send Key Promptly (< 5 seconds)                         â”‚
â”‚   Time 0:08 - Calculate key for NEW_SEED                        â”‚
â”‚   Time 0:09 - Send key (within 3 seconds)                       â”‚
â”‚                                                                 â”‚
â”‚   Tester â†’ ECU: [0x27] [0x02] [NEW_KEY]                         â”‚
â”‚   Expected:     [0x67] [0x02]                                   â”‚
â”‚   Verify:       âœ“ Unlocked successfully                         â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Security state = UNLOCKED                                     â”‚
â”‚ â€¢ Old seed discarded                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 4: Attempt Limit Reached

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 4: Exceeded Number of Attempts                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Session                                       â”‚
â”‚ â€¢ Max attempts = 3                                              â”‚
â”‚ â€¢ Delay per attempt = 10 seconds                                â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Attempt 1:                                                      â”‚
â”‚   Request Seed:  [0x27] [0x01]                                  â”‚
â”‚   Response:      [0x67] [0x01] [SEED1]                          â”‚
â”‚   Send Bad Key:  [0x27] [0x02] [WRONG]                          â”‚
â”‚   Response:      [0x7F] [0x27] [0x35]  â† Invalid Key            â”‚
â”‚   Counter:       1/3                                            â”‚
â”‚   Wait:          10 seconds                                     â”‚
â”‚                                                                 â”‚
â”‚ Attempt 2:                                                      â”‚
â”‚   Request Seed:  [0x27] [0x01]                                  â”‚
â”‚   Response:      [0x67] [0x01] [SEED2]                          â”‚
â”‚   Send Bad Key:  [0x27] [0x02] [WRONG]                          â”‚
â”‚   Response:      [0x7F] [0x27] [0x35]  â† Invalid Key            â”‚
â”‚   Counter:       2/3                                            â”‚
â”‚   Wait:          10 seconds                                     â”‚
â”‚                                                                 â”‚
â”‚ Attempt 3:                                                      â”‚
â”‚   Request Seed:  [0x27] [0x01]                                  â”‚
â”‚   Response:      [0x67] [0x01] [SEED3]                          â”‚
â”‚   Send Bad Key:  [0x27] [0x02] [WRONG]                          â”‚
â”‚   Response:      [0x7F] [0x27] [0x35]  â† Invalid Key            â”‚
â”‚   Counter:       3/3 (MAX REACHED)                              â”‚
â”‚   State:         LOCKOUT ACTIVE                                 â”‚
â”‚                                                                 â”‚
â”‚ Attempt 4 (Blocked):                                            â”‚
â”‚   Wait:          10 seconds                                     â”‚
â”‚   Request Seed:  [0x27] [0x01]                                  â”‚
â”‚   Response:      [0x7F] [0x27] [0x36]  â† Exceeded Attempts!     â”‚
â”‚   Verify:        âœ“ Lockout enforced                             â”‚
â”‚                  âœ“ No seed provided                             â”‚
â”‚                                                                 â”‚
â”‚ Recovery:                                                       â”‚
â”‚   Option A: Power cycle ECU                                     â”‚
â”‚           â†’ Counter = 0, can try again                          â”‚
â”‚                                                                 â”‚
â”‚   Option B: Wait lockout period (e.g., 10 minutes)              â”‚
â”‚           â†’ Counter = 0, can try again                          â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Cannot unlock until reset/wait                                â”‚
â”‚ â€¢ Security event logged                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 5: Wrong Session

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 5: Security in Wrong Session                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Default Session (0x01)                                 â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Attempt Seed Request in Default Session                 â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x7F] [0x27] [0x7F]                            â”‚
â”‚   Verify:       âœ“ NRC 0x7F (Service Not Supported in           â”‚
â”‚                              Active Session)                    â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Switch to Extended Session                              â”‚
â”‚   Tester â†’ ECU: [0x10] [0x03]                                   â”‚
â”‚   Expected:     [0x50] [0x03] [P2*] [P2*]                       â”‚
â”‚   Verify:       âœ“ Session changed                               â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Request Seed (Now Allowed)                              â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]                                   â”‚
â”‚   Expected:     [0x67] [0x01] [SEED]                            â”‚
â”‚   Verify:       âœ“ Seed provided                                 â”‚
â”‚                                                                 â”‚
â”‚ Step 4: Unlock Successfully                                     â”‚
â”‚   Tester â†’ ECU: [0x27] [0x02] [CORRECT_KEY]                     â”‚
â”‚   Expected:     [0x67] [0x02]                                   â”‚
â”‚   Verify:       âœ“ Unlocked                                      â”‚
â”‚                                                                 â”‚
â”‚ Step 5: Switch Back to Default Session                          â”‚
â”‚   Tester â†’ ECU: [0x10] [0x01]                                   â”‚
â”‚   Expected:     [0x50] [0x01] [P2*] [P2*]                       â”‚
â”‚   Verify:       âœ“ Session changed                               â”‚
â”‚                                                                 â”‚
â”‚ Step 6: Verify Security Lost                                    â”‚
â”‚   Tester â†’ ECU: [0x2E] [0xF1] [0x90] [DATA]                     â”‚
â”‚                 (Protected operation)                           â”‚
â”‚   Expected:     [0x7F] [0x2E] [0x7F]                            â”‚
â”‚   Verify:       âœ“ NRC 0x7F (Service not supported)              â”‚
â”‚                 âœ“ Security unlocked state lost                  â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Must unlock again if switching back to Extended               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 6: S3 Timeout (Session Timeout)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 6: S3 Timeout Loses Security                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Session                                       â”‚
â”‚ â€¢ Security UNLOCKED (Level 1)                                   â”‚
â”‚ â€¢ S3 timeout = 5 seconds                                        â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Verify Unlocked State                                   â”‚
â”‚   Time 0:00 - Tester â†’ ECU: [0x2E] [0xF1] [0x90] [DATA]         â”‚
â”‚   Expected: [0x6E] [0xF1] [0x90]                                â”‚
â”‚   Verify:   âœ“ Protected write succeeds                          â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Wait Without Communication                              â”‚
â”‚   Time 0:00 to 0:06 - No messages sent                          â”‚
â”‚   (S3 timeout expires at 0:05)                                  â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Attempt Protected Operation                             â”‚
â”‚   Time 0:06 - Tester â†’ ECU: [0x2E] [0xF1] [0x90] [DATA]         â”‚
â”‚   Expected:        ECU â†’ Tester: [0x7F] [0x2E] [0x7F]           â”‚
â”‚   Verify:          âœ“ NRC 0x7F (Session timeout)                 â”‚
â”‚                    âœ“ Returned to Default Session                â”‚
â”‚                    âœ“ Security lost                              â”‚
â”‚                                                                 â”‚
â”‚ Step 4: Re-establish Session & Security                         â”‚
â”‚   Switch Session:  [0x10] [0x03] â†’ [0x50] [0x03]                â”‚
â”‚   Request Seed:    [0x27] [0x01] â†’ [0x67] [0x01] [SEED]         â”‚
â”‚   Send Key:        [0x27] [0x02] [KEY] â†’ [0x67] [0x02]          â”‚
â”‚   Verify:          âœ“ Re-unlocked                                â”‚
â”‚                                                                 â”‚
â”‚ Step 5: Keep Alive with TesterPresent                           â”‚
â”‚   Time 0:10 - [0x3E] [0x00] â†’ [0x7E] [0x00]                     â”‚
â”‚   Time 0:14 - [0x3E] [0x00] â†’ [0x7E] [0x00]                     â”‚
â”‚   Time 0:18 - [0x3E] [0x00] â†’ [0x7E] [0x00]                     â”‚
â”‚   (Every 4 seconds, before 5 second timeout)                    â”‚
â”‚                                                                 â”‚
â”‚ Step 6: Verify Security Maintained                              â”‚
â”‚   Time 0:20 - Tester â†’ ECU: [0x2E] [0xF1] [0x90] [DATA]         â”‚
â”‚   Expected:         ECU â†’ Tester: [0x6E] [0xF1] [0x90]          â”‚
â”‚   Verify:           âœ“ Still unlocked                            â”‚
â”‚                     âœ“ Protected operation succeeds              â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Security maintained with periodic TesterPresent               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 7: Already Unlocked (Zero Seed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST CASE 7: Request Seed When Already Unlocked                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Preconditions:                                                  â”‚
â”‚ â€¢ ECU in Extended Session                                       â”‚
â”‚ â€¢ Security Level 1 UNLOCKED                                     â”‚
â”‚                                                                 â”‚
â”‚ Test Steps:                                                     â”‚
â”‚                                                                 â”‚
â”‚ Step 1: Request Seed for Same Level                             â”‚
â”‚   Tester â†’ ECU: [0x27] [0x01]  (Request Level 1 seed)           â”‚
â”‚   Expected:     [0x67] [0x01] [0x00] [0x00] [0x00] [0x00]       â”‚
â”‚   Verify:       âœ“ All-zero seed                                 â”‚
â”‚                 âœ“ Indicates already unlocked                    â”‚
â”‚                 âœ“ No key needed                                 â”‚
â”‚                                                                 â”‚
â”‚ Step 2: Try Different Level                                     â”‚
â”‚   Tester â†’ ECU: [0x27] [0x03]  (Request Level 2 seed)           â”‚
â”‚   Expected:     [0x67] [0x03] [REAL_SEED]                       â”‚
â”‚   Verify:       âœ“ Non-zero seed (Level 2 still locked)          â”‚
â”‚                 âœ“ Different levels independent                  â”‚
â”‚                                                                 â”‚
â”‚ Step 3: Verify Level 1 Still Unlocked                           â”‚
â”‚   Tester â†’ ECU: [0x2E] [Level1_Protected_DID] [DATA]            â”‚
â”‚   Expected:     [0x6E] [DID]                                    â”‚
â”‚   Verify:       âœ“ Level 1 operations still work                 â”‚
â”‚                                                                 â”‚
â”‚ Postconditions:                                                 â”‚
â”‚ â€¢ Level 1 remains unlocked                                      â”‚
â”‚ â€¢ Level 2 still locked (independent)                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Debugging Flowcharts

### Troubleshooting NRC 0x35 (Invalid Key)

```
                  NRC 0x35 Received (Invalid Key)
                              â”‚
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Check #1: Algorithm    â”‚
                 â”‚ Match?                 â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                        â”‚
          Tester & ECU             Mismatch!
          use same algo                â”‚
              â”‚                        â–¼
              â–¼               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ FIX: Update    â”‚
     â”‚ Check #2:      â”‚       â”‚ tester to use  â”‚
     â”‚ Seed Captured  â”‚       â”‚ correct crypto â”‚
     â”‚ Correctly?     â”‚       â”‚ algorithm      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
 Correct             Incorrect
 Seed Used           Seed Used
    â”‚                    â”‚
    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check #3:   â”‚   â”‚ FIX: Ensure      â”‚
â”‚ Secret Key  â”‚   â”‚ using seed from  â”‚
â”‚ Correct?    â”‚   â”‚ immediate prior  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚ seed response    â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
Correct     Wrong Key
Key Used    Stored
â”‚              â”‚
â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check #4:  â”‚  â”‚ FIX: Verify      â”‚
â”‚ Byte Order â”‚  â”‚ secret key in    â”‚
â”‚ Correct?   â”‚  â”‚ tester config    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚            â”‚
Big      Little
Endian   Endian
Match    Mismatch
â”‚            â”‚
â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check #5 â”‚  â”‚ FIX: Swap byte   â”‚
â”‚ Key      â”‚  â”‚ order to match   â”‚
â”‚ Length?  â”‚  â”‚ ECU expectation  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚          â”‚
Correct  Wrong
Length   Length
â”‚          â”‚
â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contact â”‚  â”‚ FIX: Verify key  â”‚
â”‚ ECU     â”‚  â”‚ should be N bytesâ”‚
â”‚ Vendor  â”‚  â”‚ (check spec)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Troubleshooting NRC 0x36 (Lockout)

```
              NRC 0x36 Received (Exceeded Attempts)
                              â”‚
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Step 1: Stop Trying!   â”‚
                 â”‚ More attempts won't    â”‚
                 â”‚ help                   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Step 2: Determine      â”‚
                 â”‚ Reset Method           â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                        â”‚
        Power Cycle                Time Delay
        Available?                 Available?
              â”‚                        â”‚
              â–¼                        â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Option A:      â”‚       â”‚ Option B:      â”‚
     â”‚ â€¢ Turn ECU off â”‚       â”‚ â€¢ Wait N mins  â”‚
     â”‚ â€¢ Wait 10s     â”‚       â”‚   (e.g., 10)   â”‚
     â”‚ â€¢ Turn ECU on  â”‚       â”‚ â€¢ Counter      â”‚
     â”‚ â€¢ Counter = 0  â”‚       â”‚   resets       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Step 3: Re-unlock  â”‚
                  â”‚ with CORRECT key   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Step 4: If still   â”‚
                  â”‚ failing, verify:   â”‚
                  â”‚ â€¢ Algorithm        â”‚
                  â”‚ â€¢ Secret key       â”‚
                  â”‚ â€¢ Seed capture     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Troubleshooting Session/Security Loss

```
        Protected Operation Fails (NRC 0x33 or 0x7F)
                              â”‚
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Check Current Session  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                        â”‚
         Extended/Prog              Default
              â”‚                        â”‚
              â–¼                        â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Session OK     â”‚       â”‚ ISSUE: Session â”‚
     â”‚ Check Security â”‚       â”‚ timeout (S3)   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                â”‚
              â”‚               â”‚ FIX: Send      â”‚
              â–¼               â”‚ TesterPresent  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ every 4s       â”‚
     â”‚ Request Seed   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ [0x27][0x01]   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
  All Zeros          Real Seed
  Returned           Returned
    â”‚                    â”‚
    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ISSUE:      â”‚   â”‚ ISSUE: Security  â”‚
â”‚ Already     â”‚   â”‚ was lost         â”‚
â”‚ unlocked!   â”‚   â”‚                  â”‚
â”‚ (Unexpected)â”‚   â”‚ Possible causes: â”‚
â”‚             â”‚   â”‚ â€¢ Session change â”‚
â”‚ Recheck DID â”‚   â”‚ â€¢ S3 timeout     â”‚
â”‚ protection  â”‚   â”‚ â€¢ Power glitch   â”‚
â”‚ level       â”‚   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ FIX: Re-unlock   â”‚
                  â”‚ then retry op    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Related Documentation

- **Theory Guide:** `SID_27_SECURITY_ACCESS.md`
- **Service Interactions:** `SID_27_SERVICE_INTERACTIONS.md`
- **ISO 14229-1:2020:** Section 9.3 - Security Access Service

---

**End of SID 0x27 Practical Implementation Guide**
