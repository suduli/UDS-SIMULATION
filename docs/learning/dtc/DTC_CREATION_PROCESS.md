# DTC Creation Process - Technical Reference

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           DTC SYSTEM ARCHITECTURE OVERVIEW                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     USER INTERFACE (Cluster Dashboard)                      │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌───────────────────┐              ┌───────────────────┐                  │
    │   │   FAULTS PANEL    │              │    INJECT BUTTON  │                  │
    │   │  ┌─────────────┐  │              │                   │                  │
    │   │  │ Toggle ON   │──┼──────────────┼─────▶  [INJECT]   │                  │
    │   │  │ Toggle OFF  │  │              │                   │                  │
    │   │  └─────────────┘  │              └─────────┬─────────┘                  │
    │   └───────────────────┘                        │                            │
    │                                                │                            │
    └────────────────────────────────────────────────┼────────────────────────────┘
                                                     │
                                                     │ updateDTCStatus(code, isActive)
                                                     ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          UDSContext.tsx                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐  │
    │   │                      updateDTCStatus()                              │  │
    │   │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │  │
    │   │  │ Find DTC    │───▶│ Clone from  │───▶│ Activate    │              │  │
    │   │  │ in dtcs[]   │    │ Template    │    │ Status Bits │              │  │
    │   │  └─────────────┘    └─────────────┘    └─────────────┘              │  │
    │   └─────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    │   ┌───────────────────┐                                                     │
    │   │  METRICS TRACKER  │──────── Counts active DTCs ────────────┐            │
    │   └───────────────────┘                                        │            │
    │                                                                │            │
    └────────────────────────────────────────────────────────────────┼────────────┘
                         │                                           │
                         │                                           ▼
                         ▼                                  ┌────────────────┐
    ┌─────────────────────────────────────────────────────┐ │  activeDTCs: N │
    │                    mockECU.ts                       │ └────────────────┘
    ├─────────────────────────────────────────────────────┤
    │                                                     │
    │   ╔═════════════════════════════════════════════╗   │
    │   ║            dtcTemplates (Registry)          ║   │
    │   ║  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────┐  ║   │
    │   ║  │ P0101  │ │ P0171  │ │ C0035  │ │ ...  │  ║   │
    │   ║  └────────┘ └────────┘ └────────┘ └──────┘  ║   │
    │   ╚═════════════════════════════════════════════╝   │
    │                         │                           │
    │                         │ Clone                     │
    │                         ▼                           │
    │   ╔═════════════════════════════════════════════╗   │
    │   ║         mockECUConfig.dtcs[] (Active)       ║   │
    │   ║  ┌────────┐ ┌────────┐ ┌────────┐           ║   │
    │   ║  │ DTC[0] │ │ DTC[1] │ │ DTC[n] │  ...      ║   │
    │   ║  └────────┘ └────────┘ └────────┘           ║   │
    │   ╚═════════════════════════════════════════════╝   │
    │                         │                           │
    └─────────────────────────┼───────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌─────────────────────────────────────────────────────┐
    │                  UDSSimulator.ts                    │
    ├─────────────────────────────────────────────────────┤
    │                                                     │
    │   ┌───────────────────┐     ┌───────────────────┐   │
    │   │  handleReadDTC()  │     │  handleClearDTC() │   │
    │   │    SID 0x19       │     │     SID 0x14      │   │
    │   └─────────┬─────────┘     └─────────┬─────────┘   │
    │             │                         │             │
    │             ▼                         ▼             │
    │   ┌───────────────────────────────────────────────┐ │
    │   │              UDS RESPONSE                     │ │
    │   │  ┌─────────┐  ┌─────────┐  ┌─────────┐       │ │
    │   │  │ 59 XX..│  │   54    │  │ 7F XX NRC│       │ │
    │   │  │Positive│  │Positive │  │ Negative │       │ │
    │   │  └─────────┘  └─────────┘  └─────────┘       │ │
    │   └───────────────────────────────────────────────┘ │
    │                                                     │
    └─────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────────────┐
    │                  DIAGNOSTIC CLIENT                  │
    │   ┌───────────────────────────────────────────────┐ │
    │   │  Request: 19 02 FF     Response: 59 02 FF... │ │
    │   │  Request: 14 FF FF FF  Response: 54          │ │
    │   └───────────────────────────────────────────────┘ │
    └─────────────────────────────────────────────────────┘
```

---

## DTC Lifecycle State Machine

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            DTC LIFECYCLE STATE MACHINE                              │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                   ┌───────────┐
                                   │   START   │
                                   └─────┬─────┘
                                         │
                                         │ System Initialization
                                         │ mockECUConfig.dtcs = []
                                         ▼
         ┌───────────────────────────────────────────────────────────────────┐
         │                                                                   │
         │   ╔═══════════════════════════════════════════════════════════╗   │
         │   ║                      NO_FAULT                             ║   │
         │   ║                                                           ║   │
         │   ║                   dtcs[] = []  (Empty)                    ║   │
         │   ║                                                           ║   │
         │   ║    SID 0x19 → Returns: 59 02 FF (No DTCs)                 ║   │
         │   ║                                                           ║   │
         │   ╚═══════════════════════════╤═══════════════════════════════╝   │
         │                               │                                   │
         └───────────────────────────────┼───────────────────────────────────┘
                                         │
                                         │ Fault Injected
                                         │ (User: Toggle ON → Click Inject)
                                         ▼
         ┌───────────────────────────────────────────────────────────────────┐
         │                                                                   │
         │   ╔═══════════════════════════════════════════════════════════╗   │
         │   ║                       CREATED                             ║   │
         │   ║                                                           ║   │
         │   ║    1. Lookup dtcTemplates[code]                           ║   │
         │   ║    2. Deep clone template                                 ║   │
         │   ║    3. Reset status to cleared                             ║   │
         │   ║    4. Push to dtcs[]                                      ║   │
         │   ║                                                           ║   │
         │   ╚═══════════════════════════╤═══════════════════════════════╝   │
         │                               │                                   │
         └───────────────────────────────┼───────────────────────────────────┘
                                         │
                                         │ Set Status Bits
                                         │ TF=1, TFT=1, CD=1, TFS=1
                                         ▼
         ┌───────────────────────────────────────────────────────────────────┐
         │                                                                   │
         │   ╔═══════════════════════════════════════════════════════════╗   │
         │   ║                        ACTIVE                             ║   │
         │   ║                                                           ║   │
         │   ║    testFailed        = 1  (Currently failing)             ║   │
         │   ║    confirmedDTC      = 1  (Confirmed fault)               ║   │
         │   ║    occurrenceCounter++                                    ║   │
         │   ║                                                           ║   │
         │   ║    SID 0x19 → Returns DTC with status 0x2B or 0xAB        ║   │
         │   ║                                                           ║   │
         │   ╚════════════╤══════════════════════════════╤═══════════════╝   │
         │                │                              │                   │
         └────────────────┼──────────────────────────────┼───────────────────┘
                          │                              │
          Fault Deactivated                   SID 0x14 Clear Request
          (Toggle OFF → Inject)                  14 FF FF FF
                          │                              │
                          ▼                              │
         ┌───────────────────────────────────────┐       │
         │                                       │       │
         │   ╔═══════════════════════════════╗   │       │
         │   ║          HISTORIC             ║   │       │
         │   ║                               ║   │       │
         │   ║  testFailed    = 0            ║   │       │
         │   ║  confirmedDTC  = 1            ║   │       │
         │   ║  agingCounter++               ║   │       │
         │   ║                               ║   │       │
         │   ║  DTC still visible in         ║   │       │
         │   ║  SID 0x19 responses           ║   │       │
         │   ║                               ║   │       │
         │   ╚════════════╤══════════════════╝   │       │
         │                │                      │       │
         └────────────────┼──────────────────────┘       │
                          │                              │
          ┌───────────────┤                              │
          │               │                              │
          │  Fault Re-injected                           │
          │  (Toggle ON → Inject)                        │
          │               │                              │
          │               ▼                              │
          │      Back to ACTIVE                          │
          │               │                              │
          │               │     SID 0x14 Clear Request   │
          │               │              │               │
          │               └──────────────┼───────────────┘
          │                              │
          │                              ▼
          │  ┌───────────────────────────────────────────────────────────────┐
          │  │                                                               │
          │  │   ╔═══════════════════════════════════════════════════════╗   │
          │  │   ║                       CLEARED                         ║   │
          │  │   ║                                                       ║   │
          │  │   ║    DTC removed from mockECUConfig.dtcs[]              ║   │
          │  │   ║                                                       ║   │
          │  │   ║    SID 0x19 → No longer returns this DTC              ║   │
          │  │   ║    Response: 54 (Positive)                            ║   │
          │  │   ║                                                       ║   │
          │  │   ╚═══════════════════════════╤═══════════════════════════╝   │
          │  │                               │                               │
          │  └───────────────────────────────┼───────────────────────────────┘
          │                                  │
          │                                  │ System returns to NO_FAULT
          │                                  │ (if all DTCs cleared)
          │                                  │
          └──────────────────────────────────┴────────────▶ [NO_FAULT State]
```

---

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW DIAGRAM                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘


╔═══════════════════════════════════════════════════════════════════════════════════╗
║                            FAULT INJECTION FLOW                                   ║
╠═══════════════════════════════════════════════════════════════════════════════════╣
║                                                                                   ║
║   ┌────────┐      ┌──────────────┐      ┌───────────────┐      ┌──────────────┐  ║
║   │  USER  │─────▶│   Cluster    │─────▶│  UDSContext   │─────▶│   mockECU    │  ║
║   │        │      │  Dashboard   │      │               │      │              │  ║
║   └────────┘      └──────────────┘      └───────────────┘      └──────────────┘  ║
║       │                  │                      │                     │          ║
║       │                  │                      │                     │          ║
║       │ 1. Toggle        │ 2. Inject           │ 3. updateDTCStatus  │ 4. Push  ║
║       │    Fault ON      │    Button           │    (code, true)     │    DTC   ║
║       ▼                  ▼                      ▼                     ▼          ║
║   ┌────────┐      ┌──────────────┐      ┌───────────────┐      ┌──────────────┐  ║
║   │ MAF=ON │      │  onClick()   │      │ Find template │      │ dtcs.push()  │  ║
║   │        │      │              │      │ Clone & Init  │      │              │  ║
║   └────────┘      └──────────────┘      └───────────────┘      └──────────────┘  ║
║                                                                                   ║
╚═══════════════════════════════════════════════════════════════════════════════════╝


╔═══════════════════════════════════════════════════════════════════════════════════╗
║                               READ DTC FLOW (SID 0x19)                            ║
╠═══════════════════════════════════════════════════════════════════════════════════╣
║                                                                                   ║
║   ┌────────────────┐                                                              ║
║   │ Diagnostic     │                                                              ║
║   │ Client/Tester  │                                                              ║
║   └───────┬────────┘                                                              ║
║           │                                                                       ║
║           │ 1. Send Request: 19 02 FF                                             ║
║           │    (Read DTC by Status Mask, Mask=0xFF)                               ║
║           ▼                                                                       ║
║   ┌───────────────────────────────────────────────────────────────────────────┐   ║
║   │                         UDSSimulator.handleReadDTC()                      │   ║
║   │                                                                           │   ║
║   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐      │   ║
║   │   │ Parse SubFunc   │───▶│ Filter dtcs[]   │───▶│ Build Response  │      │   ║
║   │   │ subFunc = 0x02  │    │ by statusMask   │    │ 59 02 FF [data] │      │   ║
║   │   └─────────────────┘    └─────────────────┘    └─────────────────┘      │   ║
║   │                                   │                      │                │   ║
║   │                                   ▼                      ▼                │   ║
║   │                          ┌─────────────────┐    ┌─────────────────┐      │   ║
║   │                          │mockECUConfig    │    │ Response:       │      │   ║
║   │                          │   .dtcs[]       │    │ 59 02 FF        │      │   ║
║   │                          │                 │    │ [DTC1][Stat1]   │      │   ║
║   │                          │ ┌─────┐ ┌─────┐│    │ [DTC2][Stat2]   │      │   ║
║   │                          │ │DTC0 │ │DTC1 ││    │ ...             │      │   ║
║   │                          │ └─────┘ └─────┘│    └─────────────────┘      │   ║
║   │                          └─────────────────┘             │                │   ║
║   │                                                          │                │   ║
║   └──────────────────────────────────────────────────────────┼────────────────┘   ║
║                                                              │                    ║
║           ◀──────────────────────────────────────────────────┘                    ║
║           2. Response: 59 02 FF 01 01 01 2B ...                                   ║
║                                                                                   ║
╚═══════════════════════════════════════════════════════════════════════════════════╝


╔═══════════════════════════════════════════════════════════════════════════════════╗
║                              CLEAR DTC FLOW (SID 0x14)                            ║
╠═══════════════════════════════════════════════════════════════════════════════════╣
║                                                                                   ║
║   ┌────────────────┐                                                              ║
║   │ Diagnostic     │                                                              ║
║   │ Client/Tester  │                                                              ║
║   └───────┬────────┘                                                              ║
║           │                                                                       ║
║           │ 1. Send Request: 14 FF FF FF                                          ║
║           │    (Clear All DTCs, groupOfDTC = 0xFFFFFF)                            ║
║           ▼                                                                       ║
║   ┌───────────────────────────────────────────────────────────────────────────┐   ║
║   │                        UDSSimulator.handleClearDTC()                      │   ║
║   │                                                                           │   ║
║   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐      │   ║
║   │   │ Validate Length │───▶│ Check Session   │───▶│ Clear dtcs[]    │      │   ║
║   │   │ data.length = 3 │    │ ≠ Safety (0x04) │    │ dtcs = []       │      │   ║
║   │   └─────────────────┘    └─────────────────┘    └─────────────────┘      │   ║
║   │          │                       │                      │                 │   ║
║   │     ❌ NRC 0x13             ❌ NRC 0x22             ✅ Success             │   ║
║   │   (Incorrect Length)    (Conditions Not Correct)   Response: 54           │   ║
║   │                                                                           │   ║
║   └───────────────────────────────────────────────────────────────────────────┘   ║
║                                                              │                    ║
║           ◀──────────────────────────────────────────────────┘                    ║
║           2. Response: 54 (Positive) or 7F 14 [NRC] (Negative)                    ║
║                                                                                   ║
╚═══════════════════════════════════════════════════════════════════════════════════╝
```

---

## ASIC Design Flow Diagram

The DTC system follows a formal design methodology similar to ASIC (Application-Specific Integrated Circuit) design flows. This ensures systematic development from specification to verification.

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ASIC DESIGN FLOW - DTC SYSTEM                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         📋 SPECIFICATION PHASE                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
    │   │   Requirements  │ ───▶ │     System      │ ───▶ │   Architecture  │    │
    │   │    Analysis     │      │  Specification  │      │   Definition    │    │
    │   │                 │      │ ISO 14229-1:2020│      │                 │    │
    │   └─────────────────┘      └─────────────────┘      └─────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                            📐 DESIGN PHASE                                  │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
    │   │  High-Level     │ ───▶ │   Low-Level     │ ───▶ │ RTL/Behavioral  │    │
    │   │    Design       │      │    Design       │      │ Implementation  │    │
    │   │ DTC Template    │      │  Status Byte    │      │   TypeScript    │    │
    │   │   Pattern       │      │    Logic        │      │    Modules      │    │
    │   └─────────────────┘      └─────────────────┘      └─────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        ⚙️  IMPLEMENTATION PHASE                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐  │
    │   │                     MODULE IMPLEMENTATION                           │  │
    │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │  │
    │   │  │  mockECU.ts   │  │ UDSContext.tsx│  │UDSSimulator.ts│           │  │
    │   │  │   Template    │─▶│    State      │─▶│   Protocol    │           │  │
    │   │  │   Registry    │  │  Management   │  │   Handler     │           │  │
    │   │  └───────────────┘  └───────────────┘  └───────────────┘           │  │
    │   └─────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          ✅ VERIFICATION PHASE                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
    │   │   Unit   │───▶│ Integra- │───▶│  System  │───▶│ Validation│             │
    │   │ Testing  │    │   tion   │    │ Testing  │    │   (ISO)   │             │
    │   │          │    │ Testing  │    │SID 0x19  │    │Compliance │             │
    │   │          │    │          │    │SID 0x14  │    │           │             │
    │   └──────────┘    └──────────┘    └──────────┘    └──────────┘             │
    │                                                         │                   │
    │                              ┌──────────────────────────┘                   │
    │                              │                                              │
    │                              ▼                                              │
    │                     ┌─────────────────┐                                     │
    │                     │   PASS / FAIL   │                                     │
    │                     └────────┬────────┘                                     │
    │                              │                                              │
    └──────────────────────────────┼──────────────────────────────────────────────┘
                                   │
              ┌────────────────────┴────────────────────┐
              │                                         │
              ▼ PASS                               FAIL ▼
    ┌─────────────────────┐                   ┌─────────────────────┐
    │   🚀 PRODUCTION     │                   │    REDESIGN LOOP    │
    │  ┌───────────────┐  │                   │                     │
    │  │  Deployment   │  │                   │   Return to DESIGN  │
    │  └───────┬───────┘  │                   │       PHASE         │
    │          ▼          │                   │                     │
    │  ┌───────────────┐  │                   └──────────┬──────────┘
    │  │Documentation  │  │                              │
    │  └───────┬───────┘  │                              │
    │          ▼          │                              │
    │  ┌───────────────┐  │                              │
    │  │ Maintenance   │  │                              │
    │  └───────────────┘  │                              │
    └─────────────────────┘                              │
                                                         │
              ◀──────────────────────────────────────────┘
```

### Design Flow Phases

| Phase | Activities | Outputs |
|-------|------------|---------|
| **Specification** | Requirements gathering, ISO standard analysis | System spec, Architecture doc |
| **Design** | Template pattern design, Status byte mapping | HLD/LLD documents |
| **Implementation** | TypeScript coding, Module integration | Source code files |
| **Verification** | Unit tests, Protocol compliance checks | Test reports |
| **Production** | Deployment, User documentation | Release package |

---

### V-Model Representation (Analog Style)

```
                                    V - M O D E L
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │   DEVELOPMENT (Design Down)                     VERIFICATION (Test Up)   │
    │                                                                           │
    │   ┌─────────────────┐                           ┌─────────────────┐      │
    │   │   Requirements  │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│   Acceptance    │      │
    │   │  ISO 14229-1    │        Validates          │    Testing      │      │
    │   └────────┬────────┘                           └────────▲────────┘      │
    │            │                                             │               │
    │            ▼                                             │               │
    │   ┌─────────────────┐                           ┌────────┴────────┐      │
    │   │  System Design  │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│    System       │      │
    │   │ DTC Architecture│        Validates          │    Testing      │      │
    │   └────────┬────────┘                           └────────▲────────┘      │
    │            │                                             │               │
    │            ▼                                             │               │
    │   ┌─────────────────┐                           ┌────────┴────────┐      │
    │   │   Architecture  │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│  Integration    │      │
    │   │Template Pattern │        Validates          │    Testing      │      │
    │   └────────┬────────┘                           └────────▲────────┘      │
    │            │                                             │               │
    │            ▼                                             │               │
    │   ┌─────────────────┐                           ┌────────┴────────┐      │
    │   │ Detailed Design │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│     Unit        │      │
    │   │  Status Logic   │        Validates          │    Testing      │      │
    │   └────────┬────────┘                           └────────▲────────┘      │
    │            │                                             │               │
    │            ▼                                             │               │
    │            └─────────────────┐ ┌─────────────────────────┘               │
    │                              ▼ │                                         │
    │                       ┌──────────────┐                                   │
    │                       │IMPLEMENTATION│                                   │
    │                       │  TypeScript  │                                   │
    │                       └──────────────┘                                   │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

---

### Component Block Diagram (Hardware Style)

```
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                        DTC SYSTEM BLOCK DIAGRAM                           │
    └───────────────────────────────────────────────────────────────────────────┘

    ╔═══════════════════════╗   ╔═══════════════════════╗   ╔═══════════════════════╗
    ║     USER INTERFACE    ║   ║      CORE LOGIC       ║   ║      BACKEND          ║
    ╠═══════════════════════╣   ╠═══════════════════════╣   ╠═══════════════════════╣
    ║                       ║   ║                       ║   ║                       ║
    ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║
    ║  │    Cluster      │  ║   ║  │   UDSContext    │  ║   ║  │  dtcTemplates   │  ║
    ║  │   Dashboard     │  ║   ║  │                 │  ║   ║  │    Registry     │  ║
    ║  └────────┬────────┘  ║   ║  └────────┬────────┘  ║   ║  └────────┬────────┘  ║
    ║           │           ║   ║           │           ║   ║           │           ║
    ║           ▼           ║   ║           ▼           ║   ║           ▼           ║
    ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║
    ║  │   Faults Panel  │──╫───╫─▶│updateDTCStatus()│──╫───╫─▶│ mockECUConfig   │  ║
    ║  │                 │  ║   ║  │                 │  ║   ║  │   .dtcs[]       │  ║
    ║  └─────────────────┘  ║   ║  └────────┬────────┘  ║   ║  └────────┬────────┘  ║
    ║                       ║   ║           │           ║   ║           │           ║
    ║           ▼           ║   ║           ▼           ║   ║           ▼           ║
    ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║   ║  ┌─────────────────┐  ║
    ║  │ DTC Management  │──╫───╫─▶│ Metrics Tracker │  ║   ║  │  UDSSimulator   │  ║
    ║  │     Panel       │  ║   ║  │                 │  ║   ║  │  SID Handlers   │  ║
    ║  └─────────────────┘  ║   ║  └─────────────────┘  ║   ║  └─────────────────┘  ║
    ║                       ║   ║                       ║   ║                       ║
    ╚═══════════════════════╝   ╚═══════════════════════╝   ╚═══════════════════════╝
                │                                                       ▲
                │                                                       │
                └──────────────────── UDS Request ──────────────────────┘
                                      UDS Response
```

---

### Signal Flow (Hardware-Analog Representation)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DTC CREATION SIGNAL FLOW                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────┐  │
│   │  FAULT   │───▶│ UPDATE_DTC   │───▶│  TEMPLATE   │───▶│  STATUS  │  │
│   │  TRIGGER │    │   STATUS     │    │   LOOKUP    │    │   SET    │  │
│   └──────────┘    └──────────────┘    └─────────────┘    └──────────┘  │
│        │                 │                   │                 │        │
│        │ isActive=1      │ dtcCode           │ template        │ bits   │
│        ▼                 ▼                   ▼                 ▼        │
│   ┌──────────────────────────────────────────────────────────────────┐ │
│   │                     mockECUConfig.dtcs[]                         │ │
│   │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐     │ │
│   │  │ DTC[0] │  │ DTC[1] │  │ DTC[2] │  │  ...   │  │ DTC[n] │     │ │
│   │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘     │ │
│   └──────────────────────────────────────────────────────────────────┘ │
│        │                                                      │        │
│        │ SID 0x19                                   SID 0x14  │        │
│        ▼                                                      ▼        │
│   ┌──────────┐                                          ┌──────────┐  │
│   │  READ    │                                          │  CLEAR   │  │
│   │  DTC     │◀─────────── UDS Response ──────────────▶│  DTC     │  │
│   └──────────┘                                          └──────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### DTC State Machine (Analog Timing Diagram Style)

```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         DTC LIFECYCLE STATE MACHINE                         │
    └─────────────────────────────────────────────────────────────────────────────┘

         [START]
            │
            ▼
    ╔═══════════════╗
    ║   NO_FAULT    ║ ◀─────────────────────────────────────────────────┐
    ║  dtcs[] = []  ║                                                   │
    ╚═══════╤═══════╝                                                   │
            │                                                           │
            │ Fault Injected                                            │
            │ (Toggle + Inject)                                         │
            ▼                                                           │
    ╔═══════════════╗                                                   │
    ║    CREATED    ║                                                   │
    ║ Clone Template║                                                   │
    ╚═══════╤═══════╝                                                   │
            │                                                           │
            │ Set Status Bits                                           │
            │ TF=1, CD=1, TFS=1                                         │
            ▼                                                           │
    ╔═══════════════╗         Fault Deactivated        ╔═══════════════╗│
    ║    ACTIVE     ║ ────────────────────────────────▶║   HISTORIC    ║│
    ║  testFailed=1 ║◀─────────────────────────────────║  testFailed=0 ║│
    ║ confirmedDTC=1║         Fault Re-injected        ║ confirmedDTC=1║│
    ╚═══════╤═══════╝                                  ╚═══════╤═══════╝│
            │                                                   │       │
            │ SID 0x14                              SID 0x14    │       │
            │ Clear Request                      Clear Request  │       │
            │                                                   │       │
            ▼                                                   ▼       │
    ╔═══════════════════════════════════════════════════════════════════╗
    ║                           CLEARED                                 ║──┘
    ║                      DTC Removed from dtcs[]                      ║
    ╚═══════════════════════════════════════════════════════════════════╝
```

---

### Data Bus Architecture

```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          DATA BUS ARCHITECTURE                              │
    └─────────────────────────────────────────────────────────────────────────────┘

                            ┌───────────────────────┐
                            │    SYSTEM DATA BUS    │
                            └───────────┬───────────┘
                                        │
         ┌──────────────────────────────┼──────────────────────────────┐
         │                              │                              │
         ▼                              ▼                              ▼
    ┌─────────┐                   ┌─────────┐                   ┌─────────┐
    │ ADDRESS │                   │  DATA   │                   │ CONTROL │
    │   BUS   │                   │   BUS   │                   │   BUS   │
    │ dtcCode │                   │ DTCInfo │                   │ isActive│
    └────┬────┘                   └────┬────┘                   └────┬────┘
         │                              │                              │
         │    ┌────────────────────────┬┴─────────────────────────┐    │
         │    │                        │                          │    │
         ▼    ▼                        ▼                          ▼    ▼
    ╔═════════════╗            ╔═══════════════╗            ╔═════════════╗
    ║ dtcTemplates║            ║mockECUConfig  ║            ║UDSSimulator ║
    ║  REGISTRY   ║───────────▶║    .dtcs[]    ║◀───────────║  HANDLERS   ║
    ║ (Read Only) ║   Clone    ║ (Read/Write)  ║   R/W      ║ (SID Logic) ║
    ╚═════════════╝            ╚═══════════════╝            ╚═════════════╝
         │                              │                          │
         └──────────────────────────────┴──────────────────────────┘
                                        │
                                        ▼
                            ┌───────────────────────┐
                            │    UDS RESPONSE BUS   │
                            │   59 XX [DTC Data]    │
                            │   54 (Clear Success)  │
                            │   7F XX [NRC]         │
                            └───────────────────────┘
```

---

## Status Byte Structure (ISO 14229-1)

```
Bit 7  Bit 6  Bit 5  Bit 4  Bit 3  Bit 2  Bit 1  Bit 0
┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ WIR  │ TNCT │ TFS  │ TNCL │  CD  │  PD  │ TFT  │  TF  │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘

TF   - Test Failed (currently failing)
TFT  - Test Failed This Operation Cycle
PD   - Pending DTC
CD   - Confirmed DTC
TNCL - Test Not Completed Since Last Clear
TFS  - Test Failed Since Last Clear
TNCT - Test Not Completed This Cycle
WIR  - Warning Indicator Requested
```

### Status Byte Values on Injection

| Severity | Status Byte (Hex) | Bits Set |
|----------|-------------------|----------|
| Critical/High | `0xAB` | TF, TFT, CD, TFS, WIR |
| Medium | `0x2B` | TF, TFT, CD, TFS |
| Low | `0x2B` | TF, TFT, CD, TFS |

---

## File References

| File | Purpose |
|------|---------|
| [mockECU.ts](file:///e:/spec-kit-main/UDS-SIMULATION/src/services/mockECU.ts) | DTC templates and ECU configuration |
| [UDSContext.tsx](file:///e:/spec-kit-main/UDS-SIMULATION/src/context/UDSContext.tsx) | updateDTCStatus function |
| [UDSSimulator.ts](file:///e:/spec-kit-main/UDS-SIMULATION/src/services/UDSSimulator.ts) | SID 0x19 and 0x14 handlers |
| [ClusterDashboardPage.tsx](file:///e:/spec-kit-main/UDS-SIMULATION/src/pages/ClusterDashboardPage.tsx) | Fault injection UI |
